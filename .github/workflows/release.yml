name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  build-release:
    name: Build Release
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macOS (Apple Silicon)
            rustflags: ""
            exe_ext: ""
            archive_ext: "tar.gz"

          - os: macos-latest
            target: x86_64-apple-darwin
            name: macOS (Intel)
            rustflags: ""
            exe_ext: ""
            archive_ext: "tar.gz"

          # Linux builds
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: Linux (x86_64 glibc)
            rustflags: "-C target-feature=+crt-static"
            exe_ext: ""
            archive_ext: "tar.gz"

          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            name: Linux (x86_64 musl)
            rustflags: ""
            exe_ext: ""
            archive_ext: "tar.gz"

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: Linux (ARM64)
            rustflags: ""
            exe_ext: ""
            archive_ext: "tar.gz"

          # Windows builds
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows (x86_64 MSVC)
            rustflags: ""
            exe_ext: ".exe"
            archive_ext: "zip"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Install platform-specific dependencies
      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libx11-dev \
            libxi-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxxf86vm-dev \
            libasound2-dev \
            libpulse-dev \
            libdbus-1-dev \
            libudev-dev \
            libfontconfig1-dev

          # Install cross-compilation tools if needed
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then
            sudo apt-get install -y musl-tools
          elif [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          fi

      # Cache cargo registry and build artifacts
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ matrix.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-cargo-

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ matrix.os }}-${{ matrix.target }}-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-build-

      # Build all binaries
      - name: Build workspace
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: |
          echo "Building all workspace binaries for ${{ matrix.target }}"
          cargo build --release --target ${{ matrix.target }} --locked --workspace

      # Verify binaries were created
      - name: Verify binaries
        shell: bash
        run: |
          echo "Verifying binaries exist..."
          BINARIES=(
            "scarab-daemon"
            "scarab-client"
            "scarab-plugin-compiler"
            "scarab-plugin"
          )

          MISSING=0
          for binary in "${BINARIES[@]}"; do
            BINARY_PATH="target/${{ matrix.target }}/release/${binary}${{ matrix.exe_ext }}"
            if [ -f "$BINARY_PATH" ]; then
              echo "✓ Found: $BINARY_PATH ($(du -h "$BINARY_PATH" | cut -f1))"
            else
              echo "✗ Missing: $BINARY_PATH"
              MISSING=1
            fi
          done

          if [ $MISSING -eq 1 ]; then
            echo "ERROR: Some binaries are missing!"
            exit 1
          fi

      # Smoke test binaries (basic sanity check)
      - name: Smoke test binaries (Unix)
        if: matrix.os != 'windows-latest' && matrix.target != 'aarch64-unknown-linux-gnu'
        run: |
          echo "Running smoke tests..."

          # Test daemon --version
          if target/${{ matrix.target }}/release/scarab-daemon --version; then
            echo "✓ scarab-daemon --version works"
          else
            echo "✗ scarab-daemon --version failed"
            exit 1
          fi

          # Test client --version
          if target/${{ matrix.target }}/release/scarab-client --version 2>/dev/null || true; then
            echo "✓ scarab-client binary loads (may require display)"
          fi

          # Test compiler --version
          if target/${{ matrix.target }}/release/scarab-plugin-compiler --version; then
            echo "✓ scarab-plugin-compiler --version works"
          else
            echo "✗ scarab-plugin-compiler --version failed"
            exit 1
          fi

          # Test plugin CLI --help
          if target/${{ matrix.target }}/release/scarab-plugin --help; then
            echo "✓ scarab-plugin --help works"
          else
            echo "✗ scarab-plugin --help failed"
            exit 1
          fi

      - name: Smoke test binaries (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "Running smoke tests..."

          # Test daemon --version
          try {
            & "target\${{ matrix.target }}\release\scarab-daemon.exe" --version
            Write-Host "✓ scarab-daemon --version works"
          } catch {
            Write-Host "✗ scarab-daemon --version failed"
            exit 1
          }

          # Test compiler --version
          try {
            & "target\${{ matrix.target }}\release\scarab-plugin-compiler.exe" --version
            Write-Host "✓ scarab-plugin-compiler --version works"
          } catch {
            Write-Host "✗ scarab-plugin-compiler --version failed"
            exit 1
          }

          # Test plugin CLI --help
          try {
            & "target\${{ matrix.target }}\release\scarab-plugin.exe" --help
            Write-Host "✓ scarab-plugin --help works"
          } catch {
            Write-Host "✗ scarab-plugin --help failed"
            exit 1
          }

      # Strip binaries for smaller size (Unix only)
      - name: Strip binaries (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          echo "Stripping binaries..."
          if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
            # macOS strip
            strip -x target/${{ matrix.target }}/release/scarab-daemon
            strip -x target/${{ matrix.target }}/release/scarab-client
            strip -x target/${{ matrix.target }}/release/scarab-plugin-compiler
            strip -x target/${{ matrix.target }}/release/scarab-plugin
          else
            # Linux strip (skip for cross-compiled ARM64)
            if [[ "${{ matrix.target }}" != "aarch64-unknown-linux-gnu" ]]; then
              strip --strip-all target/${{ matrix.target }}/release/scarab-daemon || true
              strip --strip-all target/${{ matrix.target }}/release/scarab-client || true
              strip --strip-all target/${{ matrix.target }}/release/scarab-plugin-compiler || true
              strip --strip-all target/${{ matrix.target }}/release/scarab-plugin || true
            fi
          fi

      # Create archive with all binaries
      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release

          # Create tarball with all binaries
          tar czf ../../../scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.tar.gz \
            scarab-daemon \
            scarab-client \
            scarab-plugin-compiler \
            scarab-plugin

          cd ../../../

          # Generate checksums
          shasum -a 256 scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.tar.gz \
            > scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.tar.gz.sha256

          echo "Archive created:"
          ls -lh *.tar.gz
          echo ""
          echo "Checksums:"
          cat *.sha256

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd target\${{ matrix.target }}\release

          # Create ZIP with all binaries
          Compress-Archive -Path scarab-daemon.exe, scarab-client.exe, scarab-plugin-compiler.exe, scarab-plugin.exe `
            -DestinationPath ..\..\..\scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.zip

          cd ..\..\..

          # Generate checksums
          Get-FileHash -Algorithm SHA256 scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.zip | `
            Select-Object -ExpandProperty Hash | `
            Out-File -FilePath scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.zip.sha256 -NoNewline

          Write-Host "Archive created:"
          Get-ChildItem *.zip | Select-Object Name, Length
          Write-Host ""
          Write-Host "Checksums:"
          Get-Content *.sha256

      # Upload artifacts for the publish job
      - name: Upload artifacts (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: scarab-${{ matrix.target }}
          path: |
            scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.tar.gz
            scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.tar.gz.sha256
          retention-days: 1

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: scarab-${{ matrix.target }}
          path: |
            scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.zip
            scarab-${{ needs.create-release.outputs.version }}-${{ matrix.target }}.zip.sha256
          retention-days: 1

  # Publish release with all artifacts
  publish-release:
    name: Publish GitHub Release
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Download all artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -ls

      # Flatten artifacts directory
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release-assets/ \;

          echo "Release assets:"
          ls -lh release-assets/

          # Create combined checksums file
          cd release-assets
          cat *.sha256 > CHECKSUMS-${{ needs.create-release.outputs.version }}.txt
          echo ""
          echo "Combined checksums:"
          cat CHECKSUMS-${{ needs.create-release.outputs.version }}.txt

      # Create GitHub release using gh CLI
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          # Create release notes
          cat > release-notes.md << 'EOF'
          # Scarab Terminal ${{ needs.create-release.outputs.version }}

          GPU-accelerated terminal emulator with plugin system.

          ## Installation

          ### macOS (Homebrew)
          ```bash
          brew tap raibid-labs/scarab
          brew install scarab
          ```

          ### Arch Linux (AUR)
          ```bash
          yay -S scarab-terminal
          # or
          paru -S scarab-terminal
          ```

          ### Other Platforms
          Download the appropriate binary for your platform below.

          ## Binaries Included

          Each archive contains:
          - `scarab-daemon` - Headless terminal server
          - `scarab-client` - Bevy-based GUI client
          - `scarab-plugin-compiler` - Fusabi plugin compiler
          - `scarab-plugin` - Plugin management CLI

          ## Verification

          Verify downloads using SHA256 checksums:
          ```bash
          sha256sum -c CHECKSUMS-${{ needs.create-release.outputs.version }}.txt
          ```

          ## Changes
          See [CHANGELOG.md](https://github.com/raibid-labs/scarab/blob/main/CHANGELOG.md) for details.
          EOF

          # Create release (draft by default)
          gh release create "$VERSION" \
            --draft \
            --title "Scarab Terminal $VERSION" \
            --notes-file release-notes.md \
            release-assets/*

          echo "Release created successfully!"
          echo "URL: https://github.com/${{ github.repository }}/releases/tag/$VERSION"

  # Update Homebrew formula
  update-homebrew:
    name: Update Homebrew Formula
    needs: [create-release, publish-release]
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Homebrew formula
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          VERSION_NUM="${VERSION#v}"

          # Download and calculate SHA256 for both architectures
          ARM64_URL="https://github.com/raibid-labs/scarab/releases/download/$VERSION/scarab-$VERSION-aarch64-apple-darwin.tar.gz"
          X64_URL="https://github.com/raibid-labs/scarab/releases/download/$VERSION/scarab-$VERSION-x86_64-apple-darwin.tar.gz"

          # Wait for assets to be available
          echo "Waiting for release assets to be available..."
          sleep 90

          # Download and calculate checksums
          ARM64_SHA=$(curl -sL "$ARM64_URL" | shasum -a 256 | cut -d' ' -f1)
          X64_SHA=$(curl -sL "$X64_URL" | shasum -a 256 | cut -d' ' -f1)

          echo "ARM64 SHA256: $ARM64_SHA"
          echo "X64 SHA256: $X64_SHA"

          # Update formula if it exists
          if [ -f "packaging/homebrew/scarab.rb" ]; then
            sed -i '' "s/version \".*\"/version \"$VERSION_NUM\"/" packaging/homebrew/scarab.rb
            sed -i '' "s/PLACEHOLDER_SHA256_ARM64/$ARM64_SHA/" packaging/homebrew/scarab.rb
            sed -i '' "s/PLACEHOLDER_SHA256_X64/$X64_SHA/" packaging/homebrew/scarab.rb

            echo "Updated Homebrew formula for version $VERSION"
          else
            echo "Homebrew formula not found, skipping update"
          fi

  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify version synchronization
        run: |
          echo "Checking version synchronization across workspace..."

          VERSION="${{ needs.create-release.outputs.version }}"
          VERSION_NUM="${VERSION#v}"

          # Check each crate's version
          CRATES=(
            "crates/scarab-protocol"
            "crates/scarab-plugin-api"
            "crates/scarab-platform"
            "crates/scarab-config"
            "crates/scarab-plugin-compiler"
            "crates/scarab-nav"
            "crates/scarab-palette"
            "crates/scarab-session"
            "crates/scarab-daemon"
            "crates/scarab-client"
          )

          MISMATCHED=0
          for crate in "${CRATES[@]}"; do
            CRATE_VERSION=$(grep '^version' "$crate/Cargo.toml" | head -1 | cut -d'"' -f2)
            if [ "$CRATE_VERSION" != "$VERSION_NUM" ]; then
              echo "✗ Version mismatch in $crate: $CRATE_VERSION != $VERSION_NUM"
              MISMATCHED=1
            else
              echo "✓ $crate: $CRATE_VERSION"
            fi
          done

          if [ $MISMATCHED -eq 1 ]; then
            echo ""
            echo "ERROR: Version mismatch detected!"
            echo "Please ensure all crate versions match the release tag."
            exit 1
          fi

          echo ""
          echo "All crate versions match release tag: $VERSION_NUM"

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in correct dependency order
          # Each crate waits for the previous one to be available on crates.io

          echo "Publishing scarab-protocol..."
          cargo publish -p scarab-protocol --allow-dirty || true
          sleep 20

          echo "Publishing scarab-plugin-api..."
          cargo publish -p scarab-plugin-api --allow-dirty || true
          sleep 20

          echo "Publishing scarab-platform..."
          cargo publish -p scarab-platform --allow-dirty || true
          sleep 20

          echo "Publishing scarab-config..."
          cargo publish -p scarab-config --allow-dirty || true
          sleep 20

          echo "Publishing scarab-plugin-compiler..."
          cargo publish -p scarab-plugin-compiler --allow-dirty || true
          sleep 20

          # These three can be published in parallel as they only depend on earlier crates
          echo "Publishing scarab-nav..."
          cargo publish -p scarab-nav --allow-dirty || true
          sleep 20

          echo "Publishing scarab-palette..."
          cargo publish -p scarab-palette --allow-dirty || true
          sleep 20

          echo "Publishing scarab-session..."
          cargo publish -p scarab-session --allow-dirty || true
          sleep 20

          # Finally, publish daemon and client
          echo "Publishing scarab-daemon..."
          cargo publish -p scarab-daemon --allow-dirty || true
          sleep 20

          echo "Publishing scarab-client..."
          cargo publish -p scarab-client --allow-dirty || true

          echo ""
          echo "All crates published successfully!"
