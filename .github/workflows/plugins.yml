name: Fusabi Plugins CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/fusabi/**'
      - 'scripts/build-plugin.sh'
      - 'scripts/plugin-validator.sh'
      - 'crates/scarab-plugin-api/**'
      - '.github/workflows/plugins.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'examples/fusabi/**'
      - 'scripts/build-plugin.sh'
      - 'scripts/plugin-validator.sh'
      - 'crates/scarab-plugin-api/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate:
    name: Validate Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Make scripts executable
        run: |
          chmod +x scripts/build-plugin.sh
          chmod +x scripts/plugin-validator.sh

      - name: Validate all plugins
        run: ./scripts/plugin-validator.sh --all

      - name: Validate plugin metadata completeness
        run: |
          echo "Checking for required metadata in all plugins..."
          EXIT_CODE=0
          for plugin in examples/fusabi/*.fsx; do
            echo "Checking $plugin..."
            if ! grep -q "@name" "$plugin"; then
              echo "ERROR: Missing @name in $plugin"
              EXIT_CODE=1
            fi
            if ! grep -q "@version" "$plugin"; then
              echo "ERROR: Missing @version in $plugin"
              EXIT_CODE=1
            fi
            if ! grep -q "@description" "$plugin"; then
              echo "WARNING: Missing @description in $plugin"
            fi
          done
          exit $EXIT_CODE

      - name: Check plugin syntax
        run: |
          echo "Checking basic F# syntax in plugins..."
          for plugin in examples/fusabi/*.fsx; do
            if [ "$plugin" = "examples/fusabi/TEMPLATE.fsx" ]; then
              continue
            fi
            echo "Checking $plugin..."
            # Basic syntax check (look for common F# patterns)
            if ! grep -E "(let|type|module|open)" "$plugin" > /dev/null; then
              echo "WARNING: $plugin may not contain valid F# syntax"
            fi
          done

  build:
    name: Build Plugins
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Build Fusabi frontend (compiler)
        run: cargo build -p fusabi-frontend || echo "fusabi-frontend not yet available, using placeholder"

      - name: Make build script executable
        run: chmod +x scripts/build-plugin.sh

      - name: Build all plugins
        run: ./scripts/build-plugin.sh --all --verbose

      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fusabi-plugins
          path: |
            examples/fusabi/*.fzb
            examples/fusabi-config/*.fzb
          retention-days: 7

  test:
    name: Test Plugin Loading
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Download plugin artifacts
        uses: actions/download-artifact@v4
        with:
          name: fusabi-plugins
          path: examples/

      - name: Run plugin loading tests
        run: cargo test -p scarab-daemon --test '*' plugin -- --nocapture || echo "Plugin tests not yet implemented"

      - name: Test plugin API compatibility
        run: |
          echo "Testing plugin API compatibility..."
          cargo test -p scarab-plugin-api --all-features

  api-compatibility:
    name: Check API Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check for API breaking changes
        run: |
          echo "Checking plugin API version..."
          API_VERSION=$(grep 'pub const API_VERSION' crates/scarab-plugin-api/src/lib.rs | grep -oP '\d+\.\d+\.\d+')
          echo "Current API version: $API_VERSION"

          # Check if plugins declare compatible API versions
          for plugin in examples/fusabi/*.fsx; do
            if [ "$plugin" = "examples/fusabi/TEMPLATE.fsx" ]; then
              continue
            fi
            PLUGIN_API=$(grep "@api-version" "$plugin" | grep -oP '\d+\.\d+\.\d+' || echo "none")
            if [ "$PLUGIN_API" = "none" ]; then
              echo "WARNING: $plugin does not declare API version"
            else
              echo "$plugin uses API version: $PLUGIN_API"
            fi
          done

      - name: Check for deprecated API usage
        run: |
          echo "Checking for deprecated API usage in plugins..."
          if grep -r "deprecated" examples/fusabi/*.fsx; then
            echo "WARNING: Found deprecated API usage in plugins"
          else
            echo "No deprecated API usage found"
          fi

  lint:
    name: Lint Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check file naming conventions
        run: |
          echo "Checking plugin file naming..."
          for file in examples/fusabi/*; do
            if [[ "$file" =~ [A-Z] ]] && [[ "$file" != *"TEMPLATE"* ]] && [[ "$file" != *"README"* ]]; then
              echo "WARNING: $file uses uppercase - consider lowercase for consistency"
            fi
          done

      - name: Check for trailing whitespace
        run: |
          echo "Checking for trailing whitespace..."
          if grep -r '[[:space:]]$' examples/fusabi/*.fsx; then
            echo "WARNING: Found trailing whitespace in plugin files"
          fi

      - name: Check line length
        run: |
          echo "Checking line length (max 100 chars recommended)..."
          awk 'length > 100 {print FILENAME":"NR": line too long ("length" chars)"}' examples/fusabi/*.fsx || true

      - name: Validate metadata format
        run: |
          echo "Validating metadata format..."
          for plugin in examples/fusabi/*.fsx; do
            if [ "$plugin" = "examples/fusabi/TEMPLATE.fsx" ]; then
              continue
            fi
            echo "Checking $plugin..."

            # Check version is semver
            VERSION=$(grep "@version" "$plugin" | grep -oP '\d+\.\d+\.\d+' || echo "")
            if [ -z "$VERSION" ]; then
              echo "ERROR: Invalid version format in $plugin"
              exit 1
            fi
          done

  documentation:
    name: Check Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "examples/fusabi/README.md" ]; then
            echo "ERROR: Missing README.md in examples/fusabi/"
            exit 1
          fi

      - name: Check template exists
        run: |
          if [ ! -f "examples/fusabi/TEMPLATE.fsx" ]; then
            echo "ERROR: Missing TEMPLATE.fsx in examples/fusabi/"
            exit 1
          fi

      - name: Verify all plugins are documented
        run: |
          echo "Checking if all plugins are mentioned in README..."
          for plugin in examples/fusabi/*.fsx; do
            if [ "$plugin" = "examples/fusabi/TEMPLATE.fsx" ]; then
              continue
            fi
            PLUGIN_NAME=$(basename "$plugin" .fsx)
            if ! grep -q "$PLUGIN_NAME" examples/fusabi/README.md; then
              echo "WARNING: $PLUGIN_NAME not documented in README"
            fi
          done

  summary:
    name: Plugin CI Summary
    runs-on: ubuntu-latest
    needs: [validate, build, test, api-compatibility, lint, documentation]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Plugin CI Summary"
          echo "================="
          echo "Validate: ${{ needs.validate.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "API Compatibility: ${{ needs.api-compatibility.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"

          if [[ "${{ needs.validate.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.api-compatibility.result }}" != "success" ]]; then
            echo "FAILED: Some plugin checks failed"
            exit 1
          fi

          echo "SUCCESS: All plugin checks passed"
