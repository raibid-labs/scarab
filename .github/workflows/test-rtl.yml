name: RTL Tests

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rtl-tests:
    name: Ratatui-testlib Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'run-rtl-tests')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-dev libwayland-dev libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Build scarab-daemon
        run: cargo build -p scarab-daemon

      - name: Run RTL basic tests (no PTY required)
        run: cargo test -p scarab-client --test ratatui_testlib_smoke test_snapshot test_cell_attributes
        continue-on-error: true

      - name: Run RTL PTY smoke tests
        env:
          SCARAB_TEST_RTL: "1"
        run: cargo test -p scarab-client --test ratatui_testlib_smoke -- --ignored
        continue-on-error: true

      - name: Report test status
        if: always()
        run: |
          echo "::notice::RTL tests completed (mvp features: bevy, async-tokio, snapshot-insta, sixel)."
          echo "::notice::PTY allocation may fail in some CI runners."
