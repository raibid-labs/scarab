# Scarab Architecture & Feature Analysis
**Date:** 2025-11-24
**Reviewer:** Gemini CLI Agent

## 1. Executive Summary

Scarab exhibits a robust, modern architecture splitting the terminal logic (`scarab-daemon`) from the rendering frontend (`scarab-client`) via shared memory IPC. This design supports high performance and crash resilience.

However, the "daily driver" readiness is compromised by brittle UI implementations in the client and feature gaps in advanced terminal protocols (Sixel, Images). While the documentation paints a picture of a feature-complete "Vimium-like" experience, the underlying code relies on hardcoded constants that will break under real-world usage (custom fonts, resizing).

## 2. Component Analysis

### 2.1 Core Architecture (`scarab-daemon` & `scarab-client`)
- **Strengths:**
    - **Separation of Concerns:** Daemon handles PTY/state, Client handles rendering/input.
    - **Performance:** Usage of `shared_memory` and `rkyv` zero-copy deserialization is excellent for latency.
    - **Bevy Integration:** Using Bevy for the client allows for a highly responsive, game-engine-grade UI.

- **Weaknesses:**
    - **Rendering Rigidity:** The `scarab-client` UI systems (`link_hints.rs`, `visual_selection.rs`) use hardcoded pixel values (e.g., `Vec2::new(100.0, ...)` for hints, `cell_width = 8.0` for selection). This completely ignores the actual font metrics, meaning overlays will likely be misaligned for any user not using the specific default font size.

### 2.2 Plugin System (`scarab-plugin-api`)
- **Status:** Solid Foundation.
- **Capabilities:** The API exposes lifecycle hooks (`on_load`, `on_input`) and grants safe access to the terminal grid via `PluginContext`.
- **Observations:** The separation allows plugins to be powerful without crashing the core daemon. The `RemoteCommand` system is a smart way to let plugins drive UI changes without direct access to the render loop.

### 2.3 Navigation & UI (`scarab-nav` vs `scarab-client`)
- **Confusion:** There is a crate `scarab-nav` which appears to be a basic/prototype implementation of navigation (URL regex only). Meanwhile, `scarab-client/src/ui/link_hints.rs` contains a more complete (but brittle) implementation.
- **Assessment:** `scarab-nav` seems redundant or deprecated in favor of the client-side implementation, or perhaps it was intended to be the logic backend but hasn't been fully integrated. The client-side implementation is feature-rich (hints, regex for URLs/Files/Emails) but technically flawed due to the hardcoded positioning mentioned above.
- **Comparison to Vimium/Cosmos:**
    - **Link Hints:** Implemented (Client-side), but brittle.
    - **Keyboard Navigation:** Basic scrolling and "Jump to" features found in Cosmos/Vimium-C are largely missing or limited to basic scrolling.
    - **Visual Mode:** Implemented (`visual_selection.rs`), supporting Character/Line/Block modes. This is a strong feature, provided the rendering bugs are fixed.

## 3. "Daily Driver" Gaps

To consider this a daily driver, the following must be addressed:

1.  **Critical UI Rendering Fixes:** The overlay system (link hints, selection) MUST use dynamic font metrics from the `TextRenderer` (Cosmic Text) instead of hardcoded 8x16 pixel values.
2.  **Sixel / Image Protocol:** No evidence of Sixel or iTerm2 image protocol support was found. This is standard in modern terminals (WezTerm, Kitty, Ghostty).
3.  **Clipboard Reliability:** While `arboard` is used, it should be tested across X11/Wayland environments, as this is a common failure point.
4.  **Font Handling:** Support for fallback fonts (nerd fonts, emoji) needs to be verified in `cosmic-text` integration.

## 4. Recommendations

1.  **Refactor UI Systems:** Inject `TextRenderer` or a `Metrics` resource into `link_hints_system` and `render_selection_system` to calculate screen coordinates based on actual cell dimensions.
2.  **Deprecate/Clarify `scarab-nav`:** If `scarab-client` owns the navigation UI, `scarab-nav` should likely be removed or refactored into a purely logic-based crate (e.g., `scarab-nav-logic`) shared by both.
3.  **Implement Sixel:** Add a Sixel parser to `scarab-daemon` and a texture-generation system to `scarab-client`.

